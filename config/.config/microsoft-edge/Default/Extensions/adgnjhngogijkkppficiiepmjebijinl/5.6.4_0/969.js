"use strict";(self.webpackChunkwhatsapp_scheduler=self.webpackChunkwhatsapp_scheduler||[]).push([[969],{89969:(e,a,s)=>{s.d(a,{getMessagesAckAndCalculateStatisticsThunk:()=>r});var t=s(36596),g=s(87435),i=s(69886),n=s(30038),c=s(92032),d=s(76114);const r=(0,n.zD)("campaigns/getMessagesAckAndCalculateStatisticsThunk",async(e,a)=>{const n=a.dispatch,r=await n(t.t2M.find({campaignId:e,$sort:{createdAt:-1},$limit:-1,$getMostRecentPerMessageId:!0})).unwrap(),m=r.filter(e=>e.waMessageKey).map(e=>({messageId:e.messageId,waMessageKey:e.waMessageKey})),l=r.filter(e=>!e.waMessageKey).map(e=>({messageId:e.messageId})),p=[...m];if(!p||0===p.length)return;let u=[];u=(0,g.B2)()?await i.B.getWaMessagesAckDataByWaMessagesKeys(p):await n(c.BuI.initiate({messageKeys:p})).unwrap();const w=u.map(e=>{var a;return{messageId:e.messageId,waMessageKey:(null===(a=p.find(a=>a.messageId===e.messageId))||void 0===a?void 0:a.waMessageKey)||"",ackData:{deliveryRemaining:e.deliveryRemaining,readRemaining:e.readRemaining,playedRemaining:e.playedRemaining}}}),o=d.M.processBatchMessageUpdates(w,r);if(o.length>0){const e=o.map(e=>{const a=e.messageId,s=r.filter(e=>e.messageId===a).sort((e,a)=>new Date(a.createdAt).getTime()-new Date(e.createdAt).getTime())[0];return{messageId:a,ackData:e.ackData,existingLog:s}}),{createBatchMessageAckUpdateLogs:a}=await Promise.resolve().then(s.bind(s,34624));(await a(e)).success}return{campaignMessageLogs:r,messagesKeys:m,messageLogWithoutWaKeys:l,realMessagesAckData:u}})}}]);